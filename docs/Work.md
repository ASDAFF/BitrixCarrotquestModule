# Техническое описание модуля Carrot Quest для Bitrix

## Установка
В дальнейшем будет установка из Marketplace. То, что есть на текущий момент - [здесь](https://github.com/M1hacka/BitrixCarrotquestModule/blob/master/docs/install.md).

## Составные части

### Файл /options.php  
Описывает то, что отображается в админке в настройках модуля (Администрирование -> Настройки -> Настройки модулей -> Carrot quest). На текущий момент это настройки ключей, включение/отключение трекинга событий и включение/отключение бонусной системы.

### Файл /constants.php  
Этот файл создан мной, его нет в спецификации битрикс. Здесь прописаны константы для всего модуля - например, его имя и пути. При смене имени модуля этот файл **ОБЯЗАТЕЛЬНО** надо менять.

### Файл /include.php  
Подключается при каждом подключении модуля через IncludeModule('carrotquest.analytics'). В том числе, если вызывается событие через AddEventListener или RegisterModuleDependences. Здесь подключаются все библиотеки (Cookie.js, carrotquest_init.js, jquery.js) и классы (из папки /classes). Кроме того создается экземпляр объекта CarrotQuestApi и записывается в глобальную переменную $CQ.

### Файл /default_option.php  
Значения параметров модуля по умолчанию.

### Файл /prolog.php  
Подключается при загрузке админки, где реально используется так и не нашел. Видимо задает какие-то константы для админки.

### Файл /install/index.php  
Описывает действия при установке и деинсталляции модулей. Имя класса должно совпадать с именем модуля (за исключением того, что точка заменяется на подчеркивание), т. е. при смене имени модуля этот файл **ОБЯЗАТЕЛЬНО** надо менять.

### Папка /lang/ 
Папка с языковыми параметрами. Внутри лежат папки /ru и /en для русского и английского языка соответственно. В них, в соответствии с путями корня модуля, лежат языковые файлы. Все они заполняют глобальный массив локализованных сообщений $MESS. Чтобы получить локализованную версию сообщения надо:
* Подключить соответствующий языковой файл через IncludeModuleLangFile(__FILE__). В принципе это делает /include.php.
* Вызвать GetMessage('index'), где 'index' - индекс в массиве $MESS. Эта функция вернет локализованное содержимое.

### Файл /classes/general/CarrotQuestApi.php  
Содержит класс со всеми функциями взаимодействия с Carrot quest. Обязательно должен быть создан перед использованием функций.
* **Connect** - подключает через js-API к CarrotQuest + отсылает идентификационные данные, если они есть.
* **Track** - Отслеживанbt событий со стороны сервера. Лучше не использовать, заменяя альтернативным вызовом jsAPI в нужном месте.
* **HttpPost**, **HttpGet** - методы для отсылки сообщений POST и GET запросами со стороны сервера.
* **GetSelectedCarrots** - получение с сервера количества выбранных пользователем при заказе морковок.
* **OrderConfirm** - метод, который при включенной бонусной системе отсылает данные о сделанном заказе со стороны сервера, при выключенной - оставляет на волю клиентской стороны (должен быть вызван отдельный обработчик из JS). Чтобы корректно сработал, в куках должны хранится:
	+ *CQBasketItems* - массив содержимого корзины
	+ *CQOrderId* - ID созданного заказа

Оба кука создаются в файле result_modifier.php переопределенного шаблона заказа из модуля sale.order.ajax. 
 
### Файл /classes/general/CarrotQuestEventHandlers.php
Обработчики всех событий, которые перехватывает система. Все методы статические.
* **IncludeHandler** - Единственное его действие - вызов файла include.php в начале каждой страницы (то есть, подключение библиотек). Изначально это делал ConnectHandler, но при переименовании модуля почему-то (так и не понял в чем дело) там include.php перестал вызываться.
* **ConnectHandler** - Выполняет подключение к CarrotQuest через CarrotQuestApi и если в options.php стоит соответствующая галочка устанавливает обработчик js событий OnBasketChange, работающий совместно с php-обработчиком OnBasketAdd. Он отлавливает событие добавления в корзину.
* **OnBasketAdd** - Устанавливает куки с добавленным в корзину объектом, чтобы в дальнейшем использовать его в обработчике js.
* **OnBeforeOrderAddHandler** - Обновляет информацию о цене заказа с учетом скидки CarrotQuest, если в настройках включены бонусы.
* **OnOrderAddHandler** - Событие оформления заказа через CarrotQuestApi
* **OnUpdateInstalled**, **LoadSaleModuleTemplates**, **LoadCatalogModuleTemplates** - Эти функции введены для того, чтобы можно было копировать шаблоны модулей catalog.element (детальное описание страницы) и sale.basket.basket (корзина) "на лету" и вносить в конец свой код (его не много, в отличие от шаблона sale.order.ajax, который переопределен. Это позволяет, с одной стороны, устанавливать обновления шаблонов этих модулей, с другой - внедрять в них свой код.
