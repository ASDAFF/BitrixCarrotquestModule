# Техническое описание модуля Carrot Quest для Bitrix

## Установка
[здесь](https://github.com/M1hacka/BitrixCarrotquestModule/blob/master/docs/install.md).

## Составные части

### Файл /options.php  
Описывает то, что отображается в админке в настройках модуля (Администрирование -> Настройки -> Настройки модулей -> Carrot quest). На текущий момент это настройки ключей, включение/отключение трекинга событий и включение/отключение бонусной системы и изменение списка шаблонов сайтов, в которые встроен модуль.

### Файл /include.php  
Подключается при каждом подключении модуля через IncludeModule('carrotquest.analytics'). В том числе, если вызывается событие через AddEventListener или RegisterModuleDependences. Здесь подключаются все библиотеки (Cookie.js, carrotquest_init.js, jquery.js) и классы (из папки /classes). Кроме того создается экземпляр объекта CarrotQuestApi и записывается в глобальную переменную $CQ.

### Файл /default_option.php  
Значения параметров модуля по умолчанию.

### Файл /prolog.php  
Подключается при загрузке админки, где реально используется так и не нашел. Видимо задает какие-то константы для админки.

### Файл /include/constants.php  
Этот файл создан мной, его нет в спецификации битрикс. Здесь прописаны константы для всего модуля - например, его имя и пути. При смене имени модуля этот файл **ОБЯЗАТЕЛЬНО** надо менять.

### Файл /include/templateOptions.php  
Этот файл создан мной, его нет в спецификации битрикс. Содержит форму для ввода списка шаблонов, в которые необходимо встроить модуль. Используется в /options.php и /install/step2.php

### Файл /include/templateOptionsOld.php  
Устаревший. Не используется. Этот файл создан мной, его нет в спецификации битрикс. Содержит форму в виде выпадающего меню сайт -> шаблон сайта.

### Файл /include/installHelp.php  
Этот файл создан мной, его нет в спецификации битрикс. Содержит форму и обработчик для отправки своего e-mail для помощи в установке. Используется в /install/step1.php, /install/step2.php, /install/step3.php

### Файл /install/index.php  
Описывает действия при установке и деинсталляции модулей. Имя класса должно совпадать с именем модуля (за исключением того, что точка заменяется на подчеркивание), т. е. при смене имени модуля этот файл **ОБЯЗАТЕЛЬНО** надо менять.

### Папка /install/js/  
Javascript библиотеки, подключаемые в системе. Все они включаются в /include.php.  При инсталляции модуля содержимое этой папки копируется в /bitrix/js/MODULE_ID
* сookie.js - создает статический класс carrotquest_cookie с методами:
	+ get (name)
	+ set (name, value, props)
	+ delete (name)
* carrotquest_init.js - хидер carrotquest, создающий его объекты. См. [Carrotquest JS API](https://github.com/materkov/cqinstall/blob/master/docs/jslib.md)

### Папка /install/images/
Картинки, используемые в модуле. При установке копируются в /bitrix/images/MODULE_ID

### Папка /install/templates/
Устаревшая. Не используется. Содержит шаблоны страниц, которые подменяет Carrotquest. На текущий момент это один шаблон - sale.order.ajax. Подмена происходит копированием шаблона в папку /bitrix/tempates/.default/components/bitrix/MODULE_ID

#### sale.order.ajax
Создан копированием станадртного шаблона покупки в магазине. Изменения:
* result_modifier.php - Файл, модифицирующий данные перед их выводом в шаблон. Считает скидку carrotquest. Пишет куки для события оформления заказа (содержимое заказа и его цену со скидкой).
* summary.php - Шаблон вывода предзаказа. Вписываем поле "Скидка Carrot Quest", трекаем событие предзаказа.
* confirm.php - Шаблон вывода подтвержденного заказа. Трекаем событие "заказ сделан".

### Файлы /install/step1.php, step2.php, step3.php, unstep.php
Шаги-шаблоны инсталляции и деинсталляции. Содержит код информации и форм, выводимых при установке модуля. Подключается файлом /install/index.php

### Файл /install/version.php
Содержит информацию о версии модуля и дате ее выпуска.

### Папка /lang/ 
Папка с языковыми параметрами. Внутри лежат папки /ru и /en для русского и английского языка соответственно. В них, в соответствии с путями корня модуля, лежат языковые файлы. Все они заполняют глобальный массив локализованных сообщений $MESS. Чтобы получить локализованную версию сообщения надо:
* Подключить соответствующий языковой файл через IncludeModuleLangFile(__FILE__). В принципе это делает /include.php.
* Вызвать GetMessage('index'), где 'index' - индекс в массиве $MESS. Эта функция вернет локализованное содержимое.

### Файл /classes/general/CarrotQuestApi.php  
Содержит класс со всеми функциями взаимодействия с Carrot quest. Обязательно должен быть создан перед использованием функций.
* **Error** - поле, содержащее текст последней ошибки класса или false если таковой не было.
* **Connect** - подключает через js-API к CarrotQuest + отсылает идентификационные данные, если они есть.
* **Track** - Отслеживанbt событий со стороны сервера. Лучше не использовать, заменяя альтернативным вызовом jsAPI в нужном месте.
* **HttpQuery** - метод для отсылки сообщений (POST и GET) запросами со стороны сервера.
* **GetSelectedCarrots** - получение с сервера количества выбранных пользователем при заказе морковок.
* **OrderConfirm** - метод, который при включенной бонусной системе отсылает данные о сделанном заказе со стороны сервера, при выключенной - оставляет на волю клиентской стороны (должен быть вызван отдельный обработчик из JS). Чтобы корректно сработал, в куках должны хранится:
	+ *CQBasketItems* - массив содержимого корзины
	+ *CQOrderId* - ID созданного заказа
* **CalcDiscount** - метод, который при включенной бонусной системе преобразует данные входного массива $arResult (формат битрикс), добавляя в них данные о скидке Carrot quest.
 
### Файл /classes/general/CarrotQuestEventHandlers.php
Обработчики всех событий, которые перехватывает система. Все методы статические.
* **ConnectHandler** - Выполняет подключение к CarrotQuest через CarrotQuestApi и если в options.php стоит соответствующая галочка устанавливает обработчик js событий OnBasketChange, работающий совместно с php-обработчиком OnBasketAdd. Он отлавливает событие добавления в корзину.
* **OnBasketAdd** - Устанавливает куки с добавленным в корзину объектом, чтобы в дальнейшем использовать его в обработчике js.
* **OnBeforeOrderAddHandler** - Обновляет информацию о цене заказа с учетом скидки CarrotQuest, если в настройках включены бонусы.
* **OnOrderAddHandler** - Событие оформления заказа через CarrotQuestApi
* **ToUTF** - сервисная функция, преобразующая объект-параметр в кодировку UTF-8.
* **SetBasketItemsCookie** - Устанавливает Cookie с содержимым корзины (JSON) для события оформления заказа.

### Файл /classes/general/CarrotQuestUpdater.php
Класс отвечает за встраивание кода Carrot quest в пользовательские шаблоны.
* **$TEMPLATE_LIST** - Список шаблонов, которые модифицированы модулем. Индексом служит имя шаблона сайта. Каждый шаблон - это объект следующей структуры:
<code>
	"NAME" - имя шаблона сайта.
	"MODIFICATIONS" - массив-список изменений, произведенных с файлами шаблона. Структура элемента:
		"COMPONENT_TEMPLATE_PATH" - путь к шаблону компонента
		"COPIED_BY_CARROTQUEST" - был ли шаблон компонента целиком скопирован carrotquest-ом
		"FILES_CREATED" - список относительных путей файлов внутри шаблона, созданных (скопированных) carrotquest-ом. Не учитывает копирование шаблона целиком ("COPIED_BY_CARROTQUEST" = true)
		"FILES_MODIFIED" - список относительных путей файлов, модифицированных carrotquest-ом.	
</code>
* **$MODIFICATIONS** - Список модификаций, которые должны быть проведены над шаблоном для корректной работы с Carrot quest. Формат каждого изменения:
<code>	
	"Имя модификации" (для удобства - имя компонента) - содержит объект следующего содержания:
		"name" - имя шаблона компонента для модификации
		"path" - абсолютный путь к источнику файлов шаблона
		"data" - массив модификаций файлов внутри шаблона. Каждый элемент имеет следующую структуру:
			"file" - относительный путь к файлу шаблона внутри "path"
			"after" - RegExp, после каждого вхождения которого надо вставить поле "data"
			"data" - Информация, которую необходимо вставить
</code>
* **UpdateTemplateList** - Обновляет TEMPLATE_LIST и соответствующие поля в опциях модуля (COption), в зависимости от параметра.
* **GetListFromRequest** - Обновляет TEMPLATE_LIST и соответствующие поля в опциях модуля используя информацию $_REQUEST. Этот массив заполняется при использовании файла /include/templateOptions.php
* **phpIsClosed** - Проверяет, закрыты ли теги php (<? ?>) в заданном файле.
* **UpdateFromRequest** - Обновляет текущие шаблоны из массива $_REQUEST. Уже существующие шаблоны не обновляются. Те, которых нет в $_REQUEST - откатываются. Новые - создаются.
* **UpdateAllTemplates** - Обновляет код шаблонов по $this->TEMPLATE_LIST и $this->MODIFICATIONS
* **RestoreAllTemplates** - Вырезает вставки Carrot quest по $this->TEMPLATE_LIST и $this->MODIFICATIONS. Скоированные шаблоны не удаляются!
* **ModifyTemplate** - Вносит в заданный в параметрах шаблон заданные изменения. Если не удались - делает откат.
* **RestoreTemplate** - Удаляет из шаблона все вставки carrot quest, используя $this->TEMPLATE_LIST.